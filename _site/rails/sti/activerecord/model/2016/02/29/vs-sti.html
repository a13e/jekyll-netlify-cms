<h2 id="前提">前提</h2>

<ul>
  <li><code class="highlighter-rouge">RepositoryA(一般ユーザー向けシステム)</code></li>
  <li><code class="highlighter-rouge">RepositoryB(管理画面)</code> の２つのレポジトリがある。</li>
</ul>

<p><code class="highlighter-rouge">RepositoryA</code>では<code class="highlighter-rouge">ActiveRecord::Base</code>を継承したモデルクラスが<code class="highlighter-rouge">app/models/</code>ではなく、<code class="highlighter-rouge">app/modesl/some_dir/</code>配下に設置されている。</p>

<p>さらに<code class="highlighter-rouge">RepositoryA</code>の<code class="highlighter-rouge">app/modesl/some_dir/</code>配下モデルのクラス名は<code class="highlighter-rouge">SomeDir::SomeModelName</code>のような<code class="highlighter-rouge">SomeDir</code>prefixがついている。</p>

<p>そして更に、複数のTBLが<code class="highlighter-rouge">Single Table Inheritance</code>のつくりを採用したつくりになっており、<code class="highlighter-rouge">type</code>カラムを持ち、しっかり<strong><em>クラス名</em></strong>を値として保存してくれている。</p>

<h2 id="問題">問題</h2>

<p>プロジェクト内においてモデル構造がイケていないという議論は行ったが、リリースまでの工数と時間の問題で一旦はこのまま走るしかないオーラが漂ってしまった。</p>

<p>問題は<code class="highlighter-rouge">RepositoryB</code>側が同じDBを見る仕様になっているため、prefixがしっかりtypeカラムに入ったTBLレコードを<code class="highlighter-rouge">ActiveRecord</code>としてどうクエリを投げるように設定してあげるかが一捻り必要となってしまった。</p>

<h2 id="対応">対応</h2>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/b153e802a9bfb6999886.js"> </script>

<p>クラスメソッドのoverrideも結構Evilなのはわかるが<code class="highlighter-rouge">RepositoryA</code>モデル名へのアプローチで本当は解決したかったので、
「目には目を歯には歯を」で対抗してみた。</p>

